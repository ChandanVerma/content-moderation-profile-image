- pipeline: "Staging"
  on: "EVENT"
  events:
  - type: "PUSH"
    refs:
    - "refs/heads/main"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
  - action: "Build Docker image"
    type: "DOCKERFILE"
    region: "us-east-2"
    docker_image_tag: "latest"
    dockerfile_path: "Dockerfile"
    repository: "content-moderation-profile"
    integration_hash: "5e145f7375a55e000f7bfa80"
  - action: "Execute: trivy vulnerability scan (AWS)"
    type: "AWS_CLI_2"
    region: "us-east-2"
    execute_commands:
    - "# Running Trivy scan"
    - "trivy image --exit-code 0 --format template --template \"@/usr/local/share/trivy/templates/html.tpl\" -o content-moderation-profile_trivy_scan.html $ACR_REGISTRY/content-moderation-profile:$BUDDY_EXECUTION_TAG"
    setup_commands:
    - "apt-get update && apt-get -y install wget unzip"
    - "wget https://github.com/aquasecurity/trivy/releases/download/v0.22.0/trivy_0.22.0_Linux-64bit.deb"
    - "dpkg -i trivy_0.22.0_Linux-64bit.deb"
    shell: "BASH"
    integration_hash: "5e145f7375a55e000f7bfa80"
  - action: "Kubernetes - execute: kubectl restart deployment"
    type: "KUBERNETES_CLI"
    cluster: "main"
    region: "us-east-2"
    execute_commands:
    - "kubectl delete pods --selector=ray-cluster-name=content-moderation-profile-cluster -n dev-pipelines"
    kubectl_version: "v1.21.0"
    shell: "SH"
    integration_hash: "5e145f7375a55e000f7bfa80"
  - action: "Send notification to buddy-ci channel on success"
    type: "SLACK"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "CPVTGKS5R"
    channel_name: "buddy-ci"
    file_attachments:
    - "fs:///content-moderation-profile_trivy_scan.html"
    integration_hash: "0pRK4mVoBDbDJgonel2EONvnGP"
  - action: "Send notification to buddy-ci channel on failure"
    type: "SLACK"
    trigger_time: "ON_FAILURE"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Failed execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "CPVTGKS5R"
    channel_name: "buddy-ci"
    file_attachments:
    - "fs:///content-moderation-profile_trivy_scan.html"
    integration_hash: "0pRK4mVoBDbDJgonel2EONvnGP"
- pipeline: "Production"
  on: "EVENT"
  events:
  - type: "PUSH"
    refs:
    - "refs/tags/*"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
  - action: "Build Docker image"
    type: "DOCKERFILE"
    region: "us-east-2"
    docker_image_tag: "$BUDDY_EXECUTION_TAG"
    dockerfile_path: "Dockerfile"
    repository: "content-moderation-profile"
    integration_hash: "5e145f7375a55e000f7bfa80"
  - action: "Execute: trivy vulnerability scan (AWS)"
    type: "AWS_CLI_2"
    region: "us-east-2"
    execute_commands:
    - "# Running Trivy scan"
    - "trivy image --exit-code 0 --format template --template \"@/usr/local/share/trivy/templates/html.tpl\" -o content-moderation-profile_trivy_scan.html $ACR_REGISTRY/content-moderation-profile:$BUDDY_EXECUTION_TAG"
    setup_commands:
    - "apt-get update && apt-get -y install wget unzip"
    - "wget https://github.com/aquasecurity/trivy/releases/download/v0.22.0/trivy_0.22.0_Linux-64bit.deb"
    - "dpkg -i trivy_0.22.0_Linux-64bit.deb"
    shell: "BASH"
    integration_hash: "5e145f7375a55e000f7bfa80"
  # - action: "Kubernetes - execute: kubectl restart deployment"
  #   type: "KUBERNETES_CLI"
  #   cluster: "main"
  #   region: "us-east-2"
  #   execute_commands:
  #   - "kubectl delete pods --selector=ray-cluster-name=integrated-content-moderation-tagging-cluster -n dev-pipelines"
  #   kubectl_version: "v1.21.0"
  #   shell: "SH"
  #   integration_hash: "5e145f7375a55e000f7bfa80"
  - action: "Update Image Tag + ArgoCD Sync"
    type: "BUILD"
    working_directory: "/buddy/content-moderation-profile"
    docker_image_name: "library/debian"
    docker_image_tag: "11.3"
    execute_commands:
    - "# Download Kustomize"
    - "curl -s \"https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh\"  | bash"
    - "cp kustomize /bin/kustomize"
    - ""
    - "# Clone Infrastructure Repository"
    - "git config --global user.email \"$GITLAB_REGISTRY_USER\""
    - "git config --global user.name \"Buddy CI\""
    - "git clone https://oauth2:$INFRASTRUCTURE_TOKEN@gitlab.com/lomotif/lomotif-infrastructure.git"
    - ""
    - "# Update the image tag and push to master"
    - "cd lomotif-infrastructure/content-moderation-profile/overlays/prod"
    - "kustomize edit set image 184884846483.dkr.ecr.us-east-2.amazonaws.com/content-moderation-profile:$BUDDY_EXECUTION_TAG"
    - "git commit -am \"Buddy-CI updated content-moderation-profile to $BUDDY_EXECUTION_TAG\""
    - "git push origin master"
    - ""
    - "# Clean directory"
    - "rm -rf lomotif-infrastructure"
    - ""
    setup_commands:
    - "apt-get update && apt-get -y install git curl"
    volume_mappings:
    - "/:/buddy/content-moderation-profile"
    ignore_image_pull_failures: true
    shell: "BASH"
  - action: "Send notification to buddy-ci channel on success"
    type: "SLACK"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "CPVTGKS5R"
    channel_name: "buddy-ci"
    file_attachments:
    - "fs:///content-moderation-profile_trivy_scan.html"
    integration_hash: "0pRK4mVoBDbDJgonel2EONvnGP"
  - action: "Send notification to buddy-ci channel on failure"
    type: "SLACK"
    trigger_time: "ON_FAILURE"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Failed execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "CPVTGKS5R"
    channel_name: "buddy-ci"
    file_attachments:
    - "fs:///content-moderation-profile_trivy_scan.html"
    integration_hash: "0pRK4mVoBDbDJgonel2EONvnGP"
